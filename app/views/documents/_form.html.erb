<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style type="text/css">
.ql-container {
  height: 180px;
}
</style>
<div class="card">
	<div class="card-body">
<%= form_with model: @document, local: true do |form| %>

  <% if @document.errors.any? %>
    <div id="error_explanation">
        <% @document.errors.full_messages.each do |msg| %>
        	<div class="alert alert-danger">
          		<li><%= msg %></li>
      		</div>
        <% end %>
      </ul>
    </div>
  <% end %>

  <p>
    <%= form.label :title %><br>
    <%= form.text_field :title, class: "form-control" %>
  </p>
 
  <p>
    <%= form.text_area :content, { class: "form-control", style: "display: none;" } %>
  </p>
  <div class="text-center"><strong>DOCUMENT EDITOR</strong></div>
  	<div class="row">
  		<div class="col-md-4">
  			<select class="form-control ql-insertRef">
				<option value="">Select document</option>
				<% @documentReferences.each do |reference| %>
					<option value="<%= reference.id %>" data-marker="[doc_<%= reference.id %>]" data-title="<%= reference.title %>"><%= reference.title %></option>
				<%end%>
			</select>
  		</div>	
  		<div class="col-md-4">
  			<select class="form-control ql-insertRef">
				<option value="">Select record</option>
				<% @recordReferences.each do |reference| %>
					<option value="<%= reference.id %>" data-marker="[rec_<%= reference.id %>]" data-title="<%= reference.title %>"><%= reference.title %></option>
				<%end%>
			</select>
  		</div>	
  		<div class="col-md-4">
  			<select class="form-control ql-insertRef">
				<option value="">Select responsible</option>
				<% @responsibles.each do |reference| %>
					<option value="<%= reference.id %>" data-marker="[res_<%= reference.id %>]" data-title="<%= reference.name %>"><%= reference.name %></option>
				<%end%>
			</select>
  		</div>	
  	</div>
  	<div class="row">
		<div class="col-sm-12">		
			<div id="editor"></div>
		 </div>
	</div>


  <p>
    <%= form.label :category_id %><br>
    
	<%= form.collection_select(:category_id, @categories, :id, :name, {prompt: "Select a category"}, {class: "form-control"}) %>
  </p>
 
  <div class="btn-group">
    <%= form.submit "Save", class: "btn btn-primary" %>
    <%= link_to 'Back', documents_path, class: "btn btn-default" %>
  </div>
<% end %>
	</div>
</div>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script type="text/javascript">
	var Embed = Quill.import('blots/embed');

/*	$(document).ready(function() {
	   	initDelta = {"ops":
			[
				{"insert":"Procedimiento de control de documentos "},
				{"insert":{"TemplateMarker":{"marker":"[doc_1]","title":"DOC-001"}}},
				{"insert":" es responsabilidad de "},
				{"insert":{"TemplateMarker":{"marker":"[res_3]","title":"RES-003"}}},
				{"insert":" y genera el registro "},
				{"insert":{"TemplateMarker":{"marker":"[rec_2]","title":"REG-002"}}},
				{"insert":".\n"}
			]};
		quill.setContents(initDelta);
	});
*/
	class TemplateMarker extends Embed {
	    static create(value) {
	        let node = super.create(value);
	        //Set up the badge, and badge colour
	        switch(value.marker.substr(1, 3)) {
	        	case 'doc':
			        node.setAttribute('class', 'btn btn-xs btn-info');
	        		break;
	        	case 'rec':
			        node.setAttribute('class', 'btn btn-xs btn-warning');
	        		break;
	        	case 'res':
			        node.setAttribute('class', 'btn btn-xs btn-success');
			        break;
			    default:
			        node.setAttribute('class', 'btn btn-xs btn-danger');
		    }
	        node.setAttribute('data-marker', value.marker);

	        //The marker is the $ rel_table[id] reference
	        node.setAttribute('data-title', value.title);
	        //
	        node.innerHTML = value.title;
	        //The title is what the user sees in their editor
	        return node;
	    }
		static value(node) {
	        return {
	            marker: node.getAttribute('data-marker'),
	            title: node.getAttribute('data-title'),
	        };
	    }
	}
	TemplateMarker.blotName = 'TemplateMarker';
	TemplateMarker.tagName = 'span';
	Quill.register({
	    'formats/TemplateMarker': TemplateMarker
	});

	var toolbarOptions = [
		['bold', 'italic', 'underline', 'strike'], 
		[{ 'header': 1 }, { 'header': 2 }], 
		[{ 'list': 'ordered'}, { 'list': 'bullet' }],
		[{ 'indent': '-1'}, { 'indent': '+1' }],
	];
/*	var toolbarOptions = [
	  ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
	  ['blockquote', 'code-block'],

	  [{ 'header': 1 }, { 'header': 2 }],               // custom button values
	  [{ 'list': 'ordered'}, { 'list': 'bullet' }],
	  [{ 'script': 'sub'}, { 'script': 'super' }],      // superscript/subscript
	  [{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
	  [{ 'direction': 'rtl' }],                         // text direction

	  [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
	  [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

	  [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
	  [{ 'font': [] }],
	  [{ 'align': [] }],

	  ['clean']                                         // remove formatting button
	];*/

	var options = {
	  modules: {
	    toolbar: toolbarOptions
	  },
	  placeholder: 'Procedure details...',
	  theme: 'snow'
	};

	var quill = new Quill('#editor', options);

	$('.ql-insertRef').on('change', function() {
		let range = quill.getSelection(true);
		quill.insertEmbed(
		    range.index,
		    //Insert the TemplateMarker in the same range as the cursor is
		    'TemplateMarker',
		    //This is the name of the Embed
		    {
				//colour: $(this).find(':selected').data('colour'),
				marker: $(this).find(':selected').data('marker'),
				title: $(this).find(':selected').data('title')
			},
			//These are the variables to enter
		);
		quill.insertText(range.index + 1, ' ', Quill.sources.USER);
		//Add a space after the marker
		quill.setSelection(range.index + 2, Quill.sources.SILENT);
		//Take the cursor to the end of the inserted TemplateMarker
		$(this).val("");
		//Reset the dropdown
	});
</script>